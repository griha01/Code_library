Create database Base777 COLLATE='utf8_unicode_ci';
use Base777;
DROP TABLE IF EXISTS `Ингредиенты1`;
DROP TABLE IF EXISTS `Ингредиенты`;
DROP TABLE IF EXISTS `Рецепты`;
DROP TABLE IF EXISTS `Продукты`;

CREATE TABLE `Продукты`(
	`№ позиции` INT NOT NULL,
	`Наименование продукта` VARCHAR(20) NOT NULL,
	`Единицы измерения` VARCHAR(10) NOT NULL,
	PRIMARY KEY (`№ позиции`)
);

CREATE TABLE `Рецепты`(
	`№ рецепта` INT NOT NULL,
	`Название блюда` VARCHAR(60) NOT NULL,
	PRIMARY KEY (`№ рецепта`)
);

CREATE TABLE `Ингредиенты`(
	`№ рецепта` INT NOT NULL,
	`Номенклатурный №` INT NOT NULL,
	`Количество` float NOT NULL,
	FOREIGN KEY (`Номенклатурный №`) REFERENCES `Продукты` (`№ позиции`) ON UPDATE CASCADE ON DELETE restrict,
	FOREIGN KEY (`№ рецепта`) REFERENCES `Рецепты` (`№ рецепта`) ON UPDATE CASCADE ON DELETE restrict
);

CREATE TABLE `Ингредиенты1`(
	`№ рецепта` INT NOT NULL,
	`Номенклатурный №` INT NOT NULL,
	`Количество` float NOT NULL,
	FOREIGN KEY (`Номенклатурный №`) REFERENCES `Продукты` (`№ позиции`) ON UPDATE CASCADE ON DELETE restrict,
	FOREIGN KEY (`№ рецепта`) REFERENCES `Рецепты` (`№ рецепта`) ON UPDATE CASCADE ON DELETE restrict
);
select * from `Продукты`;

/*3*/
INSERT INTO `Продукты` (`№ позиции`,`Наименование продукта`,`Единицы измерения`) VALUES 
	(100, 'Мидия', 'кг'),
	(101, 'Лук', 'кг'),
	(102, 'Сыр', 'граммы'),
	(103, 'Майонез', 'кг'),
	(105, 'Кальмары', 'кг'),
	(106, 'Яйцо куриное', 'шт'),
	(107, 'Огурец соленый', 'кг'),
	(108, 'Яблоки', 'кг'),
	(109, 'Дыня', 'кг');

INSERT INTO `Рецепты` (`№ рецепта`,`Название блюда`) VALUES
	(101,'Салат с кальмарами'),
	(103,'Жульен с мидиями');
    

INSERT INTO `Ингредиенты`(`№ рецепта`,`Номенклатурный №`,`Количество`) VALUES
	(103,100,0.340),
	(103,101,0.100),
	(103,102,0.080);

INSERT INTO `Ингредиенты1`(`№ рецепта`,`Номенклатурный №`,`Количество`) VALUES
	(103,103,0.100),
	(101,105,0.300),
	(101,106,3),
	(101,107,0.150),
	(101,108,0.300);
/*INSERT INTO `Рецепты` (`№ рецепта`,`Название блюда`) VALUES
(107,'Тест');*/
/*INSERT INTO `Ингредиенты`(`№ рецепта`,`Номенклатурный №`,`Количество`) VALUES
(107,100,0.340);*/
/*INSERT INTO `Ингредиенты`(`№ рецепта`,`Номенклатурный №`,`Количество`) VALUES
(103,100,0.340),
(102,100,0.340);*/
/*4*/
INSERT INTO `Ингредиенты`
SELECT *
FROM `Ингредиенты1`;



/*5*/
UPDATE `Рецепты`
SET `№ рецепта` = 102
WHERE `№ рецепта`=101;
/*6*/
START TRANSACTION;
DELETE FROM `Ингредиенты` WHERE `Номенклатурный №` = 108;
DELETE FROM `Ингредиенты1` WHERE `Номенклатурный №` = 108;
DELETE FROM `Продукты` WHERE `№ позиции`=108;
COMMIT;
/*7*/
drop table if exists `Ингредиенты1`;
/*8*/
select `№ позиции`,`Наименование продукта`,`Единицы измерения` 
from `Продукты` inner join `Ингредиенты` ON `Продукты`.`№ позиции` = `Ингредиенты`.`Номенклатурный №`
WHERE `Количество` BETWEEN 0.3 AND 2.0;
/*9*/

set @n=103;
select `Рецепты`.`№ рецепта`,`Название блюда`,`Наименование продукта`,`Единицы измерения`,Count(*) as `Количество`
FROM (`продукты` INNER JOIN `ингредиенты` ON `продукты`.`№ позиции`=`ингредиенты`.`Номенклатурный №`) 
INNER JOIN `рецепты` ON `рецепты`.`№ рецепта`=`ингредиенты`.`№ рецепта`
where `Рецепты`.`№ рецепта` = @n;
/*10*/
select `№ позиции`,`Наименование продукта`,`Единицы измерения`
from `Продукты` 
where  NOT exists(Select * from `Ингредиенты` where `Продукты`.`№ позиции`=`Номенклатурный №`);
/*11*/
select * from `ингредиенты`;
delete from `ингредиенты` where `Номенклатурный №` = 100;
select `Рецепты`.`№ рецепта`,`Название блюда`,Count(*) as `Количество`
FROM `рецепты` INNER JOIN `ингредиенты` ON `рецепты`.`№ рецепта`=`ингредиенты`.`№ рецепта`
group by 1,2
HAVING COUNT(*)>=3;
/*12*/
select count(*)/count(distinct `ингредиенты`.`№ рецепта`) as A
FROM `рецепты` INNER JOIN `ингредиенты` ON `рецепты`.`№ рецепта`=`ингредиенты`.`№ рецепта`;
/*13*/
select `№ позиции`,`Наименование продукта`,`Единицы измерения`, count(`Ингредиенты`.`№ рецепта`) as `Количество рецептов`
from `Продукты` inner join `Ингредиенты` ON `Продукты`.`№ позиции` = `Ингредиенты`.`Номенклатурный №`
group by 1,2,3;
/*14*/
Create VIEW AA as SELECT `рецепты`.`название блюда`,`ингредиенты`.`№ рецепта`, Count(`ингредиенты`.`Номенклатурный №`) AS `ингридиентов`
FROM `ингредиенты` INNER JOIN `рецепты` ON `рецепты`.`№ рецепта`=`ингредиенты`.`№ рецепта`
GROUP BY 1;
SELECT * from AA WHERE `ингридиентов` = (SELECT MAX(`ингридиентов`) FROM AA);

update `ингредиенты` set `Номенклатурный №` = 102 where `Номенклатурный №`=108;